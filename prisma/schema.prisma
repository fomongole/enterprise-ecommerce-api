generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
}

// --- ENUMS ---
enum Role {
  USER
  ADMIN
  SUPPORT
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// --- USERS & AUTH ---
model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  firstName String?
  lastName  String?
  role      Role      @default(USER)
  isActive  Boolean   @default(true)
  lastLogin DateTime?

  // Relations
  orders    Order[]
  reviews   Review[]
  cart      Cart?
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Address {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  street     String
  city       String
  state      String
  postalCode String
  country    String
  isDefault  Boolean @default(false)

  @@index([userId])
  @@map("addresses")
}

// --- CATALOG (Products & Categories) ---
model Category {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  parentId    String?

  // Self-relation for nested categories (e.g. Electronics -> Laptops)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@map("categories")
}

model Product {
  id          String @id @default(uuid())
  name        String
  slug        String @unique
  description String @db.Text

  // Money should strictly be Decimal
  basePrice Decimal @db.Decimal(10, 2)
  discount  Decimal @default(0) @db.Decimal(10, 2)

  isActive Boolean @default(true)
  stock    Int     @default(0)
  sku      String  @unique

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  images     ProductImage[]
  reviews    Review[]
  orderItems OrderItem[]
  cartItems  CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([isActive])
  @@map("products")
}

model ProductImage {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  altText   String?
  isPrimary Boolean @default(false)

  @@index([productId])
  @@map("product_images")
}

// --- SHOPPING CART ---
model Cart {
  id     String     @id @default(uuid())
  userId String?    @unique // Nullable for guest carts
  user   User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items  CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carts")
}

model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int

  @@unique([cartId, productId])
  @@map("cart_items")
}

// --- ORDERS ---
model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  totalAmount     Decimal @db.Decimal(10, 2)
  stripePaymentId String?

  items OrderItem[]

  shippingAddress Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  productName String
  price       Decimal @db.Decimal(10, 2)
  quantity    Int

  @@map("order_items")
}

// --- REVIEWS & AUDIT ---
model Review {
  id      String  @id @default(uuid())
  rating  Int     @default(5)
  comment String? @db.Text

  userId String
  user   User   @relation(fields: [userId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())

  @@index([productId])
  @@map("reviews")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  resource  String
  ipAddress String?
  userAgent String?
  payload   Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("audit_logs")
}
